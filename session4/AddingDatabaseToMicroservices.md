### **Exercise 1: Adding Data Persistence to a Database Service**

*Duration: Approximately 60 minutes*

**What you'll get out of this exercise:**

- Learn how to set up a PostgreSQL database in Docker.
- Understand how to use Docker volumes to persist data beyond the lifecycle of a container.
- Prepare a database service that can be connected to your microservices.

---

#### **Background:**

In this exercise, you will set up a PostgreSQL database as a Docker container and configure it to use Docker volumes for data persistence. This database will be used by the microservices you developed in Session 3 (**Event Service** and **User Service**) for data storage. Each microservice will have its own separate database, adhering to the **database-per-service** pattern common in microservices architectures.

---

#### **Instructions Part 1: Setting Up PostgreSQL Databases**

**1. Create a Project Directory for Session 4 (if not continuing from Session 3):**

- Navigate to your `eventhive-microservices` project directory:

  ```bash
  cd eventhive-microservices
  ```

- Ensure you have the following structure:

  ```
  eventhive-microservices/
  ├── event_service/
  ├── user_service/
  └── docker-compose.yml
  ```

**2. Update Your Docker Compose File:**

- We'll use **Docker Compose** to manage multiple containers. If you don't have a `docker-compose.yml` file, create one in the root of your project directory. If you already have one from Session 3, we'll update it.

- **docker-compose.yml:**

  ```yaml
  services:
    event_db:
      image: postgres:13
      environment:
        - POSTGRES_USER=event_user
        - POSTGRES_PASSWORD=event_pass
        - POSTGRES_DB=event_db
      volumes:
        - event_db_data:/var/lib/postgresql/data
      networks:
        - eventhive-network

    user_db:
      image: postgres:13
      environment:
        - POSTGRES_USER=user_user
        - POSTGRES_PASSWORD=user_pass
        - POSTGRES_DB=user_db
      volumes:
        - user_db_data:/var/lib/postgresql/data
      networks:
        - eventhive-network

    event_service:
      build: ./event_service
      ports:
        - "5000:5000"
      depends_on:
        - event_db
      networks:
        - eventhive-network

    user_service:
      build: ./user_service
      ports:
        - "5001:5001"
      depends_on:
        - user_db
      networks:
        - eventhive-network

  volumes:
    event_db_data:
    user_db_data:

  networks:
    eventhive-network:
      driver: bridge
  ```

  **Explanation:**

  - **event_db** and **user_db**: Separate PostgreSQL containers for the Event and User services.
  - **Volumes**: `event_db_data` and `user_db_data` are Docker volumes for data persistence.
  - **Networks**: All services are connected via the `eventhive-network` for inter-container communication.

**3. Start the Database Containers:**

- Run the following command to build and start the containers:

  ```bash
  docker-compose up -d
  ```

- Verify that the containers are running:

  ```bash
  docker ps
  ```

#### **Instructions Part 2: Persisting Data with Docker Volumes**

**4. Understanding Docker Volumes:**

- Docker volumes allow you to persist data generated by and used by Docker containers.
- In our `docker-compose.yml`, we have defined volumes for each database:

  ```yaml
  volumes:
    event_db_data:
    user_db_data:
  ```

- These volumes are mapped to the database data directories inside the containers:

  ```yaml
  volumes:
    - event_db_data:/var/lib/postgresql/data
  ```

- This ensures that data is not lost when containers are stopped or recreated.

**5. Test Data Persistence:**

- Connect to the **Event DB** container to verify data persistence:

  ```bash
  docker exec -it eventhive-microservices-event_db-1 psql -U event_user -d event_db
  ```

- Create a test table and insert data:

  ```sql
  CREATE TABLE test (id SERIAL PRIMARY KEY, name VARCHAR(50));
  INSERT INTO test (name) VALUES ('Test Event');
  SELECT * FROM test;
  \q
  ```

- Stop and remove the database container:

  ```bash
  docker-compose stop event_db
  docker-compose rm -f event_db
  ```

- Start the database container again:

  ```bash
  docker-compose up -d event_db
  ```

- Reconnect and verify the data is still present:

  ```bash
  docker exec -it eventhive-microservices-event_db-1 psql -U event_user -d event_db
  SELECT * FROM test;
  \q
  ```

- You should see the data you inserted earlier, confirming data persistence.


